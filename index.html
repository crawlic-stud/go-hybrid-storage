<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        font-family: Verdana, Geneva, Tahoma, sans-serif;
      }
      .file {
        color: #000;
        background-color: white;
        padding: 5px;
        width: fit-content;
        display: flex;
      }
      .file:hover {
        background-color: #d4d4d4;
        cursor: pointer;
        text-decoration-line: underline;
      }
      button {
        border: none;
        padding: 5px;
        margin: 5px;
        border-radius: 5px;
      }

      .btn-container {
        position: absolute;
        right: 50px;
      }

      .delete {
        background-color: rgb(236, 140, 140);
      }
      .delete:hover {
        background-color: rgb(192, 46, 46);
        color: white;
        cursor: pointer;
      }
      .download {
        background-color: rgb(184, 245, 184);
      }
      .download:hover {
        background-color: rgb(43, 121, 43);
        color: white;
        cursor: pointer;
      }
      .hide {
        display: none;
      }
      .metadata {
        font-size: smaller;
      }
    </style>
  </head>
  <body>
    <form>
      <label>Отправить файл:</label>
      <input required size="100" type="file" id="file" name="file" />
      <button type="button" onclick="uploadFile()">Отправить</button>
    </form>
    <br />
    <label>Файлы:</label>
    <button id="pagePrevious" onclick="goToPreviousPage()"><</button>
    <button id="pageNumber"></button>
    <button id="pageNext" onclick="goToNextPage()">></button>
    <label id="pageSize"></label>
    <div id="files"></div>

    <script>
      var baseUrl = "";
      var currentPage = 1;
      var isNextPage = false;
      var isPreviousPage = false;
      var pageSize = 20;

      function resetPaginator() {
        document.getElementById("pageNumber").innerHTML = currentPage;
        // document.getElementById("pageSize").innerHTML = `${pageSize} файлов`;
        var pagePrevious = document.getElementById("pagePrevious");
        var pageNext = document.getElementById("pageNext");
        pagePrevious.disabled = null;
        pageNext.disabled = null;

        isPreviousPage = currentPage > 1;

        if (!isPreviousPage) {
          pagePrevious.disabled = "disabled";
        }
        if (!isNextPage) {
          pageNext.disabled = "disabled";
        }
      }

      function goToNextPage() {
        currentPage++;
        displayFiles();
      }

      function goToPreviousPage() {
        currentPage--;
        displayFiles();
      }

      displayFiles();

      function getFilename(data) {
        var dateCreate = new Date(data.createdAt * 1000);
        return (
          data.filename +
          " (" +
          dateCreate.toLocaleDateString() +
          " " +
          dateCreate.toLocaleTimeString() +
          ")"
        );
      }

      function getFileMetadataElement(data) {
        var list = document.createElement("ul");
        for (const [key, value] of Object.entries(data)) {
          var li = document.createElement("li");
          li.innerHTML = `${key}: ${value}`;
          list.appendChild(li);
        }
        list.className = "metadata";
        list.classList.toggle("hide");
        return list;
      }

      function displayFiles() {
        console.log("displayFiles");

        fetch(
          baseUrl + "/files" + "?page=" + currentPage + "&pageSize=" + pageSize
        )
          .then((response) => response.json())
          .then((data) => {
            isNextPage = data.isNextPage;
            resetPaginator();

            data = data.items;
            data.sort(function (a, b) {
              return b.createdAt - a.createdAt;
            });
            console.log(data);

            var ul = document.createElement("ul");

            for (var i = 0; i < data.length; i++) {
              (function (file) {
                var li = document.createElement("li");
                li.id = file.fileId;
                li.innerHTML = getFilename(file);
                li.className = "file";

                var btnDelete = document.createElement("button");
                btnDelete.className = "delete";
                btnDelete.innerHTML = "Удалить";

                btnDelete.addEventListener("click", function () {
                  var confirmDelete = confirm(
                    "Вы действительно хотите удалить этот файл?"
                  );
                  if (!confirmDelete) {
                    return;
                  }

                  fetch(baseUrl + "/files/" + file.fileId, {
                    method: "DELETE",
                  }).then((response) => displayFiles());
                });

                var btnDownload = document.createElement("button");
                btnDownload.className = "download";
                btnDownload.innerHTML = "Скачать";

                btnDownload.addEventListener("click", function () {
                  window.location.href = baseUrl + "/files/" + file.fileId;
                });

                var btnContainer = document.createElement("div");
                btnContainer.className = "btn-container";

                btnContainer.appendChild(btnDownload);
                btnContainer.appendChild(btnDelete);
                li.appendChild(btnContainer);
                li.appendChild(getFileMetadataElement(file));
                ul.appendChild(li);

                li.onclick = function () {
                  var metadata = li.children[li.children.length - 1];
                  metadata.classList.toggle("hide");
                };
              })(data[i]); // Pass the current item to an IIFE
            }

            var filesElement = document.getElementById("files");
            filesElement.innerHTML = ""; // Clear existing content
            filesElement.appendChild(ul);
          });
      }

      function uploadFile() {
        var file = document.getElementById("file").files[0];
        var formData = new FormData();
        formData.append("file", file);
        fetch(baseUrl + "/files", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            return response.json();
          })
          .then((data) => {
            if (data.detail) {
              alert(data.detail);
            }
            displayFiles();
          });
      }
    </script>
  </body>
</html>
